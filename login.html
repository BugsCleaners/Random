<!DOCTYPE html>
<html>
  <head>
    <title>Login Page</title>

    <link rel="stylesheet" type="text/css" href='login_style.css'>

    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/js-cookie@2/src/js.cookie.min.js"></script>

  </head>

<form action="" method="post">
  <label for="username">Username:</label>
  <input type="text" id="username" name="username">
  <br><br>
  <label for="password">Password:</label>
  <input type="password" id="password" name="password">
  <input type="button" value="Submit" id="submitBtn">
</form>


<script>

window.onload = function() {

  const socket_login = io('https://192.168.1.158:8854');
  
  const submit_id_atd_btn = document.getElementById("submitBtn");
  const username_ = document.getElementById('username');
  const password_ = document.getElementById('password');
  
  var device_id = Cookies.get('device_id')
  var device_flag = 0
  var camera_flag = 0

  socket_login.on('connect', () => {
    console.log("Login Socket connected!");
  });

  if (device_id != undefined) {
    device_flag = Cookies.get('device_id')
    camera_flag = Cookies.get('camera_id')
  }

  submit_id_atd_btn.addEventListener("click", () => {
    const JSON_Dict = {'username': username_.value, 'password': password_.value, 'device_id': device_flag, 'camera_id': camera_flag}
    console.log(JSON_Dict);
    socket_login.emit('login_credentials', JSON.stringify(JSON_Dict));

    username_.value = '';
    password_.value = '';

  });

  socket_login.on('login_response', (data) => {
    var J_dict = JSON.parse(data);
    response_gl = J_dict.response;
    camera_id = J_dict.camera_id;
    console.log("received message: " + data);

    if (camera_id == camera_flag) {
      if (response_gl == 'login_successful') {
        
        // If the server says the request was successful, reload the current page
        console.log('login successful')     
        Cookies.set('logged_in', 'True')  

        setTimeout(() => {
          window.location.href = 'https://192.168.1.158:8088/index.html';
        }, 2000);
      }
    }

    if (camera_flag == 0) {
      if (response_gl == 'first_login') {
        
        console.log('login successful')  
        Cookies.set('logged_in', 'True')  
        Cookies.set('camera_id', J_dict.camera_id)  
        Cookies.set('device_id', J_dict.device_id)   
        
        setTimeout(() => {
          window.location.href = 'https://192.168.1.158:8088/index.html';
        }, 3000);
      }
    }  
  })
}
 
</script>
</html>

